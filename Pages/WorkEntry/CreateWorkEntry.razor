@page "/workEntry/create"
@* @using TimeTrackerClient.Services.WorkEntry
@inject IWorkEntryService workEntryService
@inject NavigationManager navManager

<h3>CreateWorkEntry</h3>

@code {
    

} *@
@* @page "/employee/create-work-entry" *@
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using TimeTrackerClient.Providers
@using TimeTrackerClient.Services.Base
@using TimeTrackerClient.Services.WorkEntry
@attribute [Authorize(Roles = "User")]
@inject IWorkEntryService WorkEntryService
@inject NavigationManager navManager
@inject AuthenticationStateProvider authStateProvider

@inject IJSRuntime JSRuntime



<header style="text-align: center; margin-bottom: 30px;">
    <h1 style="font-size: 3rem; font-weight: 700; margin-bottom: 10px;">TimeTracker Client</h1>
</header>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger py-2 px-3 my-2 text-center mx-auto" style="max-width: 500px;">
        @errorMessage
    </div>
}

@if (!string.IsNullOrEmpty(successMessage))
{
    <div class="alert alert-success py-2 px-3 my-2 text-center mx-auto" style="max-width: 500px;">
        @successMessage
    </div>
}
<div style="display: flex; justify-content: center; align-items: center; min-height: 80vh; background-color: #f4f6f8; padding: 20px;">
    <form @onsubmit="HandleWorkEntry" @onsubmit:preventDefault="true"
          style="background-color: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); max-width: 400px; width: 100%;">

        <h3 style="margin-bottom: 20px; color: #34495e; text-align: center;">Create Work Entry</h3>

        <div style="margin-bottom: 15px;">
            <label for="date" style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">Date</label>
            <input type="date" id="date" @bind="workEntryDto.Date" required
                   style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" />
        </div>

        <div style="margin-bottom: 15px;">
            <label for="hours" style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">Hours</label>
            <input type="number" id="hours" @bind="hours" min="0" max="23" step="1" required
                   style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" />
        </div>

        <div style="margin-bottom: 15px;">
            <label for="minutes" style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">Minutes</label>
            <input type="number" id="minutes" @bind="minutes" min="0" max="59" step="1" required
                   style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" />
        </div>

        <button type="submit" disabled="@isLoading"
                style="width: 100%; padding: 10px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; font-weight: 600; cursor: pointer; transition: background-color 0.3s ease;">
            @if (isLoading)
            {
                <text>Creating...</text>
            }
            else
            {
                <text>Submit</text>
            }
        </button>
    </form>
    
</div>


@code {
    private WorkEntryCreateDto workEntryDto = new WorkEntryCreateDto{Date=DateTime.Today};
    private string? rid;
    private int hours = 0;
    private int minutes = 0;
    private bool isLoading = false;
    private string? errorMessage ;
    private string? successMessage;
    protected override async Task OnInitializedAsync()
    {

        IEnumerable<Claim>? claims = await ((ApiAuthenticationStateProvider)authStateProvider).GetClaims();

        if (claims == null)
        {
            navManager.NavigateTo("users/login");
            return;
        }

        rid = claims.FirstOrDefault(x => x.Type == "rid")?.Value;

        workEntryDto.EmployeeId = Convert.ToInt32( rid);



    }

    private async Task HandleWorkEntry()
    {
        try
        {
            isLoading = true;
            errorMessage = string.Empty;
            successMessage = string.Empty;

            // Convert hours and minutes to TimeSpan
            workEntryDto.Duration = new System.TimeSpan(hours, minutes, 0);

            var response = await WorkEntryService.CreateAsync(workEntryDto);

            if (response.Success)
            {
                successMessage = response.Message;
                StateHasChanged();
                await Task.Delay(3000);
                successMessage = null;
                // Reset form
                workEntryDto = new WorkEntryCreateDto
                {
                    EmployeeId = Convert.ToInt32(rid),
                    Date = DateTime.Today
                };
                
            }
            else
            {
                errorMessage = response.Message;
            }
        }
        catch (Exception ex)
        {
            errorMessage = "An unexpected error occurred while creating the work entry.";
        }
        finally
        {
            isLoading = false;
        }
    }
}
